{% extends 'base.html' %}
{% block content %}
<h2>Project: {{p.title}} <small>#{{p.id}}</small></h2>
<p class="muted">Goal: {{p.goal}}</p>

<div class="grid">
  <section class="card">
    <h3>Steps</h3>
    <table class="steps">
      <tr><th>#</th><th>Title</th><th>Req</th><th>Status</th><th>Actions</th></tr>
      {% for s in steps %}
      <tr id="step-row-{{s.id}}">
        <td>{{s.order_idx}}</td>
        <td>{{s.title}}</td>
        <td>{{'Yes' if s.required else 'No'}}</td>
        <td><span class="badge {{s.status}}">{{s.status}}</span></td>
        <td>
          <button hx-post="{{ url_for('step_mirror', step_id=s.id) }}" hx-target="#mirror" hx-swap="innerHTML">Mirror</button>
          {% if s.status != 'done' %}
          <button class="ghost" hx-post="{{ url_for('step_apply', step_id=s.id) }}" hx-trigger="click" hx-on::after-request="if(event.detail.success) { location.reload(); }">Apply</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
    <form method="post" action="{{ url_for('project_rollback', project_id=p.id) }}">
      <button class="danger">Rollback to last checkpoint</button>
    </form>
  </section>

  <section class="card" id="mirror">
    <h3>Quantum Mirror</h3>
    <p class="muted">Select "Mirror" on a step to preview diffs before applying.</p>
  </section>

  <section class="card">
    <h3>Artifacts</h3>
    {% if artifacts %}
      <ul>
        {% for a in artifacts %}
          <li>[{{a.type}}] <a href="{{ url_for('artifact_download', artifact_id=a.id) }}">{{a.uri}}</a> <small>{{a.hash[:8]}}</small></li>
        {% endfor %}
      </ul>
    {% else %}
      <p>None yet.</p>
    {% endif %}
  </section>

  <section class="card">
    <h3>Events (latest)</h3>
    <ul class="events">
      {% for e in events %}
        <li><code>{{e.kind}}</code> â€” {{e.ts}} <small class="muted">{{e.payload_json}}</small></li>
      {% endfor %}
    </ul>
    <h4>Checkpoints</h4>
    <ul>
      {% for c in checkpoints %}
        <li>{{c.ts}} â€” {{c.zip_path}}</li>
      {% endfor %}
    </ul>
  </section>
</div>
{% endblock %}

<!-- === LILITH ACTIONS === -->
<style>
  .actions { display:flex; gap:.5rem; flex-wrap: wrap; }
  .log { font-family: ui-monospace,Consolas,monospace; font-size:.9rem; white-space:pre-wrap; }
</style>

<script>
async function postJson(url) {
  const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }});
  const data = await res.json();
  if (!res.ok || !data.ok) throw new Error(data.error || ("HTTP " + res.status));
  return data;
}
async function mirrorStep(stepId) {
  const btn = document.getElementById("mirror-"+stepId);
  const out = document.getElementById("out-"+stepId);
  btn.disabled = true; out.textContent = "Mirroring…";
  try {
    const data = await postJson(`/api/steps/${stepId}/mirror`);
    out.textContent = JSON.stringify(data.preview, null, 2);
  } catch(e){ out.textContent = "Mirror failed: " + e.message; }
  finally { btn.disabled = false; }
}
async function applyStep(stepId) {
  const btn = document.getElementById("apply-"+stepId);
  const out = document.getElementById("out-"+stepId);
  if (!confirm("Apply this step? A checkpoint will be created.")) return;
  btn.disabled = true; out.textContent = "Applying…";
  try {
    const data = await postJson(`/api/steps/${stepId}/apply`);
    out.textContent = JSON.stringify(data.result, null, 2);
  } catch(e){ out.textContent = "Apply failed: " + e.message; }
  finally { btn.disabled = false; }
}
async function rollback(projectId) {
  const btn = document.getElementById("rollback-btn");
  btn.disabled = true;
  try {
    await postJson(`/api/projects/${projectId}/rollback`);
    alert("Rolled back to last checkpoint.");
    location.reload();
  } catch(e){ alert("Rollback failed: " + e.message); }
  finally { btn.disabled = false; }
}
</script>

{% if project %}
<div class="actions" style="margin:.75rem 0 1rem;">
  <button id="rollback-btn" onclick="rollback({{ project.id }})">Rollback to last checkpoint</button>
</div>
{% endif %}

<!-- augment each step row with Mirror/Apply -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("[data-step-id]").forEach(row => {
    const stepId = row.getAttribute("data-step-id");
    // skip if already patched
    if (row.querySelector(".actions")) return;
    const actions = document.createElement("div");
    actions.className = "actions";
    actions.innerHTML = `
      <button id="mirror-${stepId}" onclick="mirrorStep(${stepId})">Mirror</button>
      <button id="apply-${stepId}" onclick="applyStep(${stepId})">Apply</button>
    `;
    const out = document.createElement("pre");
    out.id = "out-" + stepId;
    out.className = "log";
    row.appendChild(actions);
    row.appendChild(out);
  });
});
</script>
<!-- === LILITH ACTIONS (end) === -->

